!!! 5
%html{ :lang => "en" }
  %head
    %meta{ :charset => "utf-8" }
    %meta{ "http-equiv" => "X-UA-Compatible", :content => "IE=edge" }
    %meta{ :name => "viewport", :content => "width=device-width, initial-scale=1" }

    %meta{ :name => "description", :content => "A web interface to support browsing public ChIP-Seq data via IGV." }
    %meta{ :name => "author", :content => "Shinya Oki, Tazro Ohta" }

    %title= "ChIP-Atlas"

    // Bootstrap core and typeahead CSS
    %link{ :href => "#{app_root}/css/bootstrap.min.css", :rel => "stylesheet" }
    %link{ :href => "#{app_root}/css/typeaheadjs.css", :rel => "stylesheet" }

    // Custom style for this website
    %link{ :href => "#{app_root}/style.css", :rel => "stylesheet"}

  %body
    %nav.navbar.navbar-inverse.navbar-fixed-top
      .container
        .navbar-header
          %button.navbar-toggle.collapsed{ :type => "button", "data-toggle" => "collapse", "data-target" => "#navbar", "aria-expanded" => "false", "aria-controls" => "navbar" }
            %span.sr-only Toggle navigation
            %span.icon-bar
            %span.icon-bar
            %span.icon-bar
          %a.navbar-brand{ :href => "#{app_root}" }= "ChIP-Atlas"
        #navbar.collapse.navbar-collapse
          %ul.nav.navbar-nav
            %li
              %a{ :href => "#{app_root}/peak_browser" }= "Peak Browser"
            %li
              %a{ :href => "#{app_root}/target_genes" }= "Target Genes"
            %li
              %a{ :href => "#{app_root}/colo" }= "Colocalization"
            %li
              %a{ :href => "#{app_root}/in_silico_chip" }
                %span.italic
                  in silico
                ChIP
            %li
              %a{ :href => "https://github.com/inutano/chip-atlas/wiki" }= "Documentation"
          %ul.nav.navbar-nav.navbar-right
            %li.dropdown
              %a.dropdown-toggle{ "data-toggle" => "dropdown", role: "button", "aria-haspopup" => true, "aria-expanded" => false }
                Jump to Experiment
                %span.caret
              %ul.dropdown-menu{ style: "padding:12px;" }
                %li
                  %form.form-inline
                    .form-group
                      %input.form-control#jumpToExperiment{ type: "text", value: "ERX032305", "aria-describedby" => "exp-help" }
                    %button.btn.btn-default.go-experiment{ type: 'submit' }
                      Go
                    %p.help-block#exp-help
                      Jump to individual experiment result page by SRA Exp ID.


    .container
      .header
        %h1
          ChIP-Atlas -
          %span.italic
            in silico
          ChIP
        %p= "Analyze your data with public ChIP-seq data."
      .container.job-info
        %p
          Result page URL will be available for a week from the time when 'status' is 'finished'.
        %table.table
          %tr
            %td
              Project title
            %td#project-title
          %tr
            %td
              Requst ID
            %td#request-id
          %tr
            %td
              Submitted at:
            %td#submitted-at
          %tr
            %td
              Estimated finishing time:
            %td#estimated-finishing-time
          %tr
            %td
              Current time:
            %td#current-time
          %tr
            %td
              Status
            %td#status
              Requesting
          %tr
            %td
              Result URL:
            %td
              %a#result-url

    /
      Bootstrap Core Javascript
      =========================
    %link{ :href => "#{app_root}/css/flexselect.css", :rel => "stylesheet", :type => "text/css", :media => "screen" }
    %script{ :src => "#{app_root}/js/jquery.min.js" }
    %script{ :src => "#{app_root}/js/bootstrap.min.js" }
    %script{ :src => "#{app_root}/js/ie10-viewport-bug-workaround.js" }
    %script{ :src => "#{app_root}/js/liquidmetal.js" }
    %script{ :src => "#{app_root}/js/jquery.flexselect.js" }
    %script{ :src => "#{app_root}/js/typeahead.bundle.js" }

    / 'code here'

    :javascript
      $('button.go-experiment').on('click', function(event){
        event.preventDefault();
        var expid = $('input#jumpToExperiment').val();
        window.open('/view?id='+expid);
      });

      // get url parameter
      var getUrlParameter = function getUrlParameter(sParam) {
        var sPageURL = decodeURIComponent(window.location.search.substring(1)),
          sURLVariables = sPageURL.split('&'),
          sParameterName,
          i;

        for (i = 0; i < sURLVariables.length; i++) {
          sParameterName = sURLVariables[i].split('=');
          if (sParameterName[0] === sParam) {
            return sParameterName[1] === undefined ? true : sParameterName[1];
          }
        }
      };

      // set variables
      var reqId = getUrlParameter('id');
      var title = getUrlParameter('title');

      var wabiUrl = "http://ddbj.nig.ac.jp/wabi/chipatlas/";
      var reqUrl = wabiUrl + reqId;
      var resultUrl = reqUrl + "?info=result";

      $('td#project-title').text(title);
      $('td#request-id').text(reqId);
      $('a#result-url').text(resultUrl);

      // date format converter function
      function dateFormat(date){
        var f = date.toString().split(" ");
        return f[4] + " (" + f[1] + "-" + f[2] + "-" + f[3] + ")";
      }

      // submit time and clock
      var now = new Date();
      $('td#submitted-at').text(dateFormat(now));

      var calcm = getUrlParameter('calcm');
      var calcTime;
      switch(true){
        case "-" == calcm:
          calcTime = 0;
          break;
        case /mins$/.test(calcm):
          calcTime = calcm.split(" ")[0];
          break;
        case /hr$/.test(calcm):
          calcTime = calcm.split(" ")[0] * 60;
          break;
      }
      var estFinish = new Date(now.setMinutes(now.getMinutes()+parseInt(calcTime,10)));
      $('td#estimated-finishing-time').text(dateFormat(estFinish));

      // Clock
      $(function(){
        setInterval(function(){
          t = new Date();
          $('td#current-time').text(dateFormat(t));
        }, 1000);
      });

      // checking status
      $(function(){
        var tdStatus = $('td#status');
        var interval = setInterval(function(){
          $.get("/wabi_chipatlas?id="+reqId, function(status){
            tdStatus.text(status);
            if(status == "finished"){
              tdStatus.css("color","red");
              $('a#result-url').attr('href', resultUrl);
              clearInterval(interval);
            }
          });
        }, 10000);
      });
